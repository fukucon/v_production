# KaleidoChrome 開発メモ

## プロジェクト概要
KaleidoChrome VTuber事務所の公式サイトをPHP化し、ブログ機能を追加。

---

## 開発環境情報

### サーバー環境（お名前ドットコム）
- **PHPバージョン**: 8.4
- **データベース名**: iofy8_kaleidochrome
- **DBホスト**: mysql1036.onamae.ne.jp
- **文字コード**: utf8mb4
- **DBユーザー**: iofy8_admin
- **DBパスワード**: Masa@0118

---

## バージョン管理

### v1.0 - 静的HTMLサイト（オリジナル）
**日付**: 2025-11-18
**説明**: 静的HTMLで構成された基本サイト

**ファイル構成**:
```
/home/zono/v_production/
├── index.html          # トップページ
├── talents.html        # タレント紹介
├── liver.html          # Vライバーとは
├── linkup.html         # 個人配信者向け
├── check.html          # 応募者向けチェックリスト
├── privacy.html        # プライバシーポリシー
├── styles.css          # スタイルシート
├── script.js           # JavaScript
├── .htaccess          # URL書き換え設定
└── images/            # 画像ディレクトリ
    ├── sampleimage.png
    └── girl.png
```

**特徴**:
- アニメーション背景（カレイドスコープ、光ビーム、浮遊棒）
- レスポンシブデザイン
- プライバシーポリシー対応

---

### v2.0 - PHP化 + CMS機能実装（完了）
**開始日**: 2025-11-18
**完了日**: 2025-11-18
**説明**: 静的サイトをPHP化し、フル機能のCMSを実装。タレント管理、ブログ、検索機能を追加。

**新規追加ファイル**:
```
/home/zono/v_production/
├── includes/              # 共通PHPファイル
│   ├── db.php            # データベース接続（SQLite/MySQL自動切替）
│   ├── config.php        # 本番環境設定
│   ├── config_local.php  # ローカル環境設定
│   └── functions.php     # 共通関数（認証、CSRF、日付など）
├── database/             # SQLiteデータベース（ローカル開発用）
│   └── kaleidochrome.db
├── admin_kc/             # 管理画面（推測されにくいパス）
│   ├── index.php         # ログインページ
│   ├── dashboard.php     # ダッシュボード
│   ├── posts.php         # 記事管理（タレントタグ機能付き）
│   ├── talents.php       # タレント管理（登録・編集）
│   ├── images.php        # 画像ファイル名管理
│   └── logout.php        # ログアウト
├── blog.php              # ブログ一覧（4-3-2グリッド）
├── blog_detail.php       # ブログ詳細（タレントタグ表示）
├── talents.php           # タレント一覧（検索機能付き、4-3-2グリッド）
├── uploads/              # アップロード画像保存先
├── sql/                  # SQLスクリプト
│   ├── setup_sqlite.sql  # SQLite用初期化
│   ├── setup.sql         # MySQL用初期化
│   ├── create_talents_table.sql           # タレントテーブル
│   ├── create_post_talents_table.sql      # 記事タレント中間テーブル
│   └── add_name_kana_to_talents.sql       # タレント名（かな）追加
├── setup_local.php       # ローカル環境セットアップ
└── README_SETUP.md       # セットアップ手順
```

**データベーステーブル**:
- `admin_users`: 管理者アカウント（パスワードハッシュ化）
- `posts`: ブログ記事（タイトル、本文、画像、ステータス、閲覧数）
- `talents`: タレント情報（名前、かな、画像、タグ、詳細）
- `post_talents`: 記事とタレントの関連（中間テーブル、最大50件）
- `images`: 画像ファイル名管理

**主要機能**:

#### 1. タレント管理システム
- タレント登録・編集・削除
- フィールド：
  - タレント名、タレント名（かな）
  - 画像ファイル名
  - あかさたなタグ（あ～わ行）
  - フリーワードタグ（カンマ区切り）
  - キャッチフレーズ、詳細

#### 2. タレント検索機能
- あかさたな検索（プルダウン、自動検索）
- フリーワードタグ検索（オートコンプリート、自動検索）
- 検索結果の動的フィルタリング
- 4列（PC） / 3列（タブレット） / 2列（スマホ）グリッド表示

#### 3. ブログシステム
- 記事作成・編集・削除
- タレントタグ機能（最大50件）
  - プルダウンでタレント選択
  - 追加ボタンでタグ追加
  - ピル型タグ表示、×ボタンで削除
- 改行自動変換（nl2br）
- HTMLタグ使用可能
- ピクトグラムアイコン（カレンダー、目）
- 4列（PC） / 3列（タブレット） / 2列（スマホ）グリッド表示
- 背景ぼかし効果（backdrop-filter）

#### 4. 管理画面
- セッション認証
- CSRF対策
- ダッシュボード（統計表示）
- 記事管理（下書き/公開）
- タレント管理
- 画像ファイル名管理

#### 5. デザイン
- レスポンシブ対応
- アニメーション背景（既存維持）
- グラスモーフィズム（ぼかし背景）
- グリッドレイアウト最適化
- ホバーエフェクト

---

## 重要な技術仕様

### データベース自動切替
ローカル（SQLite）と本番（MySQL）を自動で切り替え：
```php
// database/kaleidochrome.db の存在で判定
$isLocal = file_exists(__DIR__ . '/../database/kaleidochrome.db');
```

### 検索ロジック
フリーワードタグ検索は4パターンで検索：
```php
// 1. 完全一致（単独タグ）: "ゲーム"
// 2. 先頭一致: "ゲーム, 歌枠"
// 3. 中間一致: "配信, ゲーム, 歌枠"
// 4. 末尾一致: "配信, ゲーム"
```

### タレントタグ管理
- JavaScriptで動的管理（Map使用）
- hidden inputsで送信
- 最大50件制限
- 編集時は既存タグを自動復元

### セキュリティ
- パスワード: `password_hash()` / `password_verify()`
- CSRF: トークン生成・検証
- XSS: `htmlspecialchars()` （h関数）
- SQLインジェクション: プリペアドステートメント
- セッション: `session_regenerate_id()`

### レスポンシブブレークポイント
- PC: デフォルト（4列グリッド）
- タブレット: max-width: 1024px（3列グリッド）
- スマホ: max-width: 768px（2列グリッド）

---

## 開発履歴

### 2025-11-18

#### 午前: 静的サイト完成（v1.0）
- アニメーション背景実装（下から広がる円、浮遊棒、光ビーム）
- ヘッダーメニューのフェードイン実装
- プライバシーポリシーページ作成
- レスポンシブ対応完了

#### 午後～夜: PHP化 & CMS実装（v2.0）

**フェーズ1: 基盤構築**
- データベース設計・構築
- SQLite（ローカル）/MySQL（本番）自動切替システム
- 共通機能実装（DB接続、認証、CSRF、関数）
- ローカル開発環境セットアップスクリプト作成

**フェーズ2: 管理画面**
- ログイン機能（セッション認証）
- ダッシュボード（統計表示）
- 記事管理（作成・編集・削除、下書き/公開）
- 画像ファイル名管理
- タレント管理（登録・編集・削除）

**フェーズ3: タレント機能**
- タレントテーブル設計・構築
  - name_kana（タレント名かな）追加
  - kana_tag（あかさたなタグ）追加
  - free_tags（フリーワードタグ）追加
- タレント検索機能実装
  - あかさたなプルダウン検索
  - フリーワードタグ検索（オートコンプリート）
  - 自動検索（ボタンレス）
- talents.html → talents.php 移行
- グリッドレイアウト最適化（4-3-2）

**フェーズ4: ブログ機能強化**
- 基本ブログ機能実装
- タレントタグ機能追加
  - post_talents 中間テーブル作成
  - タレント選択UI（プルダウン + 追加ボタン）
  - ピル型タグ表示（赤グラデーション）
  - 最大50件制限
- 改行自動変換（nl2br）実装
- 抜粋フィールド削除
- ピクトグラムアイコン実装（カレンダー、目）
- 余白・レイアウト調整
- 背景ぼかし効果（backdrop-filter）
- グリッドレイアウト最適化（4-3-2）

**フェーズ5: デザイン最適化**
- タレント・ブログの表示簡素化（画像+タイトル/名前のみ）
- 余白調整（タイトル、画像、本文）
- 文字色調整（本文を濃く）
- レスポンシブ対応完了

**技術的な改善**
- 検索クエリの最適化（完全一致、前方一致、中間一致、後方一致）
- タレントタグの動的管理（JavaScript）
- フォームバリデーション
- エラーハンドリング
- セキュリティ対策（XSS、SQLインジェクション、CSRF）

---

## TODO

### 完了項目
- [x] データベース構築（SQLite/MySQL両対応）
- [x] DB接続ファイル作成
- [x] セッション管理
- [x] 共通関数作成
- [x] ログイン機能
- [x] ダッシュボード
- [x] 記事管理（CRUD、タレントタグ機能）
- [x] 画像ファイル名管理
- [x] タレント管理（CRUD、検索機能）
- [x] ブログ一覧表示
- [x] ブログ詳細表示
- [x] タレント検索機能
- [x] グリッドレイアウト最適化（4-3-2）
- [x] レスポンシブ対応
- [x] ローカルテスト

### 未完了項目
- [ ] 本番環境へのデプロイ
  - [ ] MySQLテーブル作成
  - [ ] FTPアップロード
  - [ ] 本番環境テスト
  - [ ] 管理者アカウント作成

### 今後の拡張案
- [ ] タレント詳細ページ
- [ ] ブログのタレント絞り込み検索
- [ ] ページネーション改善
- [ ] 記事のカテゴリ機能
- [ ] サイトマップ生成
- [ ] OGP対応
- [ ] RSS フィード

---

## セキュリティ対策

1. **管理画面**:
   - 推測されにくいURL（/admin_kc/）
   - セッション認証
   - CSRF対策
   - SQLインジェクション対策（プリペアドステートメント）

2. **ファイルアップロード**:
   - 画像は手動FTP経由
   - ファイル名のみをDB管理

3. **データベース**:
   - パスワードハッシュ化（password_hash）
   - XSS対策（htmlspecialchars）

---

## デプロイ手順（本番環境）

### 1. 事前準備
- お名前ドットコムのコントロールパネルでMySQL作成
- DB情報を `includes/config.php` に設定

### 2. ファイルアップロード（FTP）
```
/home/zono/v_production/ の内容を全てアップロード
※ database/ ディレクトリは除く（SQLiteはローカルのみ）
```

### 3. データベース初期化
phpMyAdminまたはSSHで以下を実行：
```sql
-- sql/setup.sql を実行
-- sql/create_talents_table.sql を実行
-- sql/create_post_talents_table.sql を実行
```

### 4. 管理者アカウント作成
```sql
INSERT INTO admin_users (username, password, email) VALUES
('admin', '$2y$10$...', 'admin@example.com');
-- パスワードは事前にハッシュ化して設定
```

### 5. パーミッション設定
```
uploads/ → 755 または 777（書き込み可能に）
```

### 6. 動作確認
- トップページ表示確認
- 管理画面ログイン確認
- ブログ機能確認
- タレント機能確認

## 注意事項

- **既存HTMLファイルは削除・変更しない**
- **新規機能は別ファイルとして追加**
- **データベース接続情報は外部に漏らさない**
- **/admin_kc/ のURLは第三者に教えない**
- **本番環境では必ず HTTPS を使用**
- **定期的なバックアップ（DB + ファイル）**

---

## 連絡先

開発者: Claude Code
プロジェクト: KaleidoChrome Official Website
