RewriteEngine On

# Set index.html and index.php as default directory index
DirectoryIndex index.php index.html

# セキュリティ: .env ファイルへのアクセスを拒否
<Files .env>
    Order allow,deny
    Deny from all
</Files>

# セキュリティ: データベースファイルへのアクセスを拒否
<FilesMatch "\.(db|sqlite|sqlite3)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# URL Rewrite Rules for Clean URLs
# 注意: 具体的なルールを先に記述し、一般的なルールを後に記述

# 管理画面とアップロードフォルダは除外（直接アクセス許可）
RewriteCond %{REQUEST_URI} ^/admin_kc/ [OR]
RewriteCond %{REQUEST_URI} ^/uploads/
RewriteRule ^ - [L]

# タレント詳細ページ: /talents/[slug] → talent_detail.php?slug=[slug]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^talents/([a-z0-9-]+)$ talent_detail.php?slug=$1 [L,QSA]

# ブログ詳細ページ: /blog/[slug] → blog_detail.php?slug=[slug]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^blog/([a-z0-9-]+)$ blog_detail.php?slug=$1 [L,QSA]

# タレント一覧: /talents → talents.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^talents$ talents.php [L,QSA]

# ブログ一覧: /blog → blog.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^blog$ blog.php [L,QSA]

# Redirect .html URLs to non-.html URLs (except index.html)
RewriteCond %{THE_REQUEST} \s/(.+?)\.html[\s?]
RewriteCond %{REQUEST_URI} !^/index\.html$
RewriteRule ^(.+)\.html$ /$1 [R=301,L]

# Redirect .php URLs to non-.php URLs (for blog and talents)
RewriteCond %{THE_REQUEST} \s/(.+?)\.php[\s?]
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} !^/admin_kc/
RewriteRule ^(.+)\.php$ /$1 [R=301,L]

# Add .html extension internally if file exists
RewriteCond %{REQUEST_FILENAME}.html -f
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^\.]+)$ $1.html [L]

# Add .php extension internally if file exists
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/admin_kc/
RewriteRule ^([^\.]+)$ $1.php [L]
